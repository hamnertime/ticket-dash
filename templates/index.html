<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integotec - Incident Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        // Pass config from Flask to JavaScript
        window.FRESHSERVICE_BASE_URL = "{{ freshservice_base_url }}";
        window.AUTO_REFRESH_MS = {{ auto_refresh_ms }};
        window.OPEN_INCIDENT_STATUS_ID = {{ OPEN_INCIDENT_STATUS_ID }}; // Renamed from OPEN_TICKET_STATUS_ID
        window.WAITING_ON_CUSTOMER_STATUS_ID = {{ WAITING_ON_CUSTOMER_STATUS_ID }};
        // Add other constants if JS needs them
    </script>
</head>
<body>
    <div class="container">
        <h1>Integotec - Incident Dashboard</h1>
        <div class="info-bar">
            <span>Total Active Incidents: <strong id="total-active-incidents-count">{{ s1_open_incidents|length + s2_waiting_agent_incidents|length + s3_remaining_incidents|length }}</strong></span>
            <span>Dashboard Generated: <em id="dashboard-generated-time">Loading...</em></span>
            <button id="theme-toggle">Toggle Theme</button>
        </div>

        {# --- Section 1: Open Incidents --- #}
        <div class="section-header">Open Incidents (<span id="s1-incident-count">{{ s1_open_incidents|length }}</span>)</div>
        <table class="ticket-table" id="s1-incident-table">
            <thead>
                <tr>
                    <th class="col-id sortable-header" data-sort-key="id">ID</th>
                    <th class="col-subject sortable-header" data-sort-key="subject">Subject</th>
                    <th class="col-requester sortable-header" data-sort-key="requester_name">Requester</th>
                    <th class="col-agent sortable-header" data-sort-key="agent_name">Agent</th>
                    <th class="col-priority sortable-header" data-sort-key="priority_raw">Priority</th>
                    <th class="col-action-sla sortable-header" data-sort-key="sla_text">Action / SLA</th>
                    <th class="col-updated sortable-header" data-sort-key="updated_at_str">Updated</th>
                    <th class="col-created sortable-header" data-sort-key="created_at_str">Created</th>
                </tr>
            </thead>
            <tbody id="s1-incidents-body">
                {% if s1_open_incidents %}
                    {% for incident in s1_open_incidents %}
                    <tr>
                        <td class="ticket-id"><a href="{{ freshservice_base_url }}{{ incident.id }}" target="_blank">{{ incident.id }}</a></td>
                        <td class="ticket-subject description-tooltip">{{ incident.subject | truncate(60, True) }}{% if incident.description_text %}<span class="tooltiptext">{{ incident.description_text | striptags | truncate(300, True) }}</span>{% endif %}</td>
                        <td>{{ incident.requester_name }}</td>
                        <td>{{ incident.agent_name }}</td>
                        <td><span class="priority-{{ incident.priority_text }}">{{ incident.priority_text }}</span></td>
                        <td class="col-action-sla">
                            <span class="sla-status-text {{ incident.sla_class }}">{{ incident.sla_text }}</span>
                            {% if incident.first_responded_at_iso is none and incident.fr_due_by_str %}
                                <div class="datetime-container" data-utc-datetime="{{ incident.fr_due_by_str }}" data-prefix="FR Due: ">
                                    <small class="local-datetime">Loading...</small>
                                </div>
                            {% endif %}
                        </td>
                        <td>{{ incident.updated_friendly }}</td>
                        <td>{{ incident.created_days_old }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <p id="s1-no-incidents-message" class="no-tickets-message" {% if s1_open_incidents %}style="display: none;"{% endif %}>No incidents currently in 'Open' status.</p>

        {# --- Section 2: Waiting on Agent --- #}
        <div class="section-header">Waiting on Agent (<span id="s2-incident-count">{{ s2_waiting_agent_incidents|length }}</span>)</div>
        <table class="ticket-table" id="s2-incident-table">
            <thead>
                <tr>
                    <th class="col-id sortable-header" data-sort-key="id">ID</th>
                    <th class="col-subject sortable-header" data-sort-key="subject">Subject</th>
                    <th class="col-requester sortable-header" data-sort-key="requester_name">Requester</th>
                    <th class="col-agent sortable-header" data-sort-key="agent_name">Agent</th>
                    <th class="col-priority sortable-header" data-sort-key="priority_raw">Priority</th>
                    <th class="col-action-sla sortable-header" data-sort-key="sla_text">Action / Status</th>
                    <th class="col-updated sortable-header" data-sort-key="updated_at_str">Updated</th>
                    <th class="col-created sortable-header" data-sort-key="created_at_str">Created</th>
                </tr>
            </thead>
            <tbody id="s2-incidents-body">
                {% if s2_waiting_agent_incidents %}
                    {% for incident in s2_waiting_agent_incidents %}
                    <tr>
                        <td class="ticket-id"><a href="{{ freshservice_base_url }}{{ incident.id }}" target="_blank">{{ incident.id }}</a></td>
                        <td class="ticket-subject description-tooltip">{{ incident.subject | truncate(60, True) }}{% if incident.description_text %}<span class="tooltiptext">{{ incident.description_text | striptags | truncate(300, True) }}</span>{% endif %}</td>
                        <td>{{ incident.requester_name }}</td>
                        <td>{{ incident.agent_name }}</td>
                        <td><span class="priority-{{ incident.priority_text }}">{{ incident.priority_text }}</span></td>
                        <td class="col-action-sla">
                            <span class="sla-status-text {{ incident.sla_class }}">{{ incident.sla_text }}</span>
                        </td>
                        <td>{{ incident.updated_friendly }}</td>
                        <td>{{ incident.created_days_old }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <p id="s2-no-incidents-message" class="no-tickets-message" {% if s2_waiting_agent_incidents %}style="display: none;"{% endif %}>No incidents currently in 'Waiting on Agent' status.</p>

        {# --- Section 3: Remaining Active Incidents --- #}
        <div class="section-header">Remaining Active Incidents (<span id="s3-incident-count">{{ s3_remaining_incidents|length }}</span>)</div>
        <table class="ticket-table" id="s3-incident-table">
            <thead>
                <tr>
                    <th class="col-id sortable-header" data-sort-key="id">ID</th>
                    <th class="col-subject sortable-header" data-sort-key="subject">Subject</th>
                    <th class="col-requester sortable-header" data-sort-key="requester_name">Requester</th>
                    <th class="col-agent sortable-header" data-sort-key="agent_name">Agent</th>
                    <th class="col-priority sortable-header" data-sort-key="priority_raw">Priority</th>
                    <th class="col-action-sla sortable-header" data-sort-key="status_text">Status</th>
                    <th class="col-updated sortable-header" data-sort-key="updated_at_str">Updated</th>
                    <th class="col-created sortable-header" data-sort-key="created_at_str">Created</th>
                </tr>
            </thead>
            <tbody id="s3-incidents-body">
                {% if s3_remaining_incidents %}
                    {% for incident in s3_remaining_incidents %}
                    <tr>
                        <td class="ticket-id"><a href="{{ freshservice_base_url }}{{ incident.id }}" target="_blank">{{ incident.id }}</a></td>
                        <td class="ticket-subject description-tooltip">{{ incident.subject | truncate(60, True) }}{% if incident.description_text %}<span class="tooltiptext">{{ incident.description_text | striptags | truncate(300, True) }}</span>{% endif %}</td>
                        <td>{{ incident.requester_name }}</td>
                        <td>{{ incident.agent_name }}</td>
                        <td><span class="priority-{{ incident.priority_text }}">{{ incident.priority_text }}</span></td>
                        <td class="col-action-sla">
                            <span class="sla-status-text {{ incident.sla_class }}">{{ incident.sla_text }}</span>
                        </td>
                        <td>{{ incident.updated_friendly }}</td>
                        <td>{{ incident.created_days_old }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <p id="s3-no-incidents-message" class="no-tickets-message" {% if s3_remaining_incidents %}style="display: none;"{% endif %}>No other active incidents found.</p>
    </div>

    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</body>
</html>
